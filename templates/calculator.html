{% extends "base.html" %}
{% block title %}Cost Calculator{% endblock %}
{% block content %}
<style>
.drop-shadow-1 {
    box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
}
.label-input {
    display: flex;
    justify-content: space-around;
    padding-right: 30px;
    align-items: center;
}
.label-input > * { display: inline-block; }
.list-group {
    padding: 10px;
    background: white;
    border-radius: 0 0 7px 7px;
    display: none;
    max-height: 400px;
    overflow-y: auto;
  }

.list-group li {
    list-style: none;
    background: white;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.list-group div { padding: 10px; }
.list-group li:hover {  background: #dfe4ea; }

.item-first-row {
    display: flex;
    align-items: center;
}
.item-first-row-text {
    width: 510px;
    padding: 5px 10px;
}
.lighter {
    font-weight: lighter;
}
.item-th {
    max-width: 122px;
    padding: 0 10px;
}

#price-placeholder table tr td {
    padding-right: 30px;
    padding-bottom: 9px;
}
</style>

<h3>Cost Calculator <span class="sep"></span></h3>
<div class="g-3" style="display: flex;">
    <div class="label-input">
        <label for="title" class="col-form-label">Title</label>&nbsp;&nbsp;&nbsp;
        <input type="text" id="title" class="form-control form-control-sm" placeholder="Title of my estimate">
    </div>

    <div class="label-input">
        <label for="company" class="col-form-label">Company</label>&nbsp;&nbsp;&nbsp;
        <input type="text" id="company" class="form-control form-control-sm" placeholder="Company">
    </div>

    <div class="label-input">
        <label for="author" class="col-form-label">Author</label>&nbsp;&nbsp;&nbsp;
        <input type="text" id="author" class="form-control form-control-sm" placeholder="Author">
    </div>
</div>
<br>
<div id="calculator">
    <div id="zones"></div>
    <br>
    <button id="add-zone" class="btn btn-sm add-zone" style="font-size: 0.8rem;">+ Add Zone</button>

    <h3>Total <span class="sep"></span></h3>
<div style="display: flex">
    <div class="label-input">
        <label for="support" class="col-form-label">Support</label>&nbsp;&nbsp;&nbsp;
        <select id="support" class="form-select form-select-sm" style="width: 290px;">
            <option value="e">Entreprise (30% - minimum 5000 EUR)</option>
            <option value="b" selected>Business (10% - minimum 250 EUR)</option>
            <option value="p">Premium (50)</option>
            <option value="s">Standard</option>
        </select>
    </div>
    <div class="label-input">
        <label for="totaldiscount" class="col-form-label">Additional Discount (%)</label>&nbsp;&nbsp;&nbsp;
        <input type="number" min="0" max="30" id="totaldiscount" class="form-control form-control-sm" placeholder="0" value="0" style="width: 54px; background: transparent">
    </div>
</div>
<div id="price-placeholder"></div>

</div>
    <h3>Share <span class="sep"></span></h3>
    <div style="display: flex;">
        <div>
        <button class="btn btn-primary drop-shadow-1" id="copy-link-button" style="white-space: nowrap;"> 
            <svg width="12" height="10" viewBox="0 0 12 10" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M11.1586 5.24877C12.2805 4.04744 12.2805 2.10191 11.1586 0.900579C10.1658 -0.162549 8.60114 -0.300755 7.45942 0.573136L7.42765 0.596525C7.14172 0.815529 7.0762 1.24078 7.28071 1.54483C7.48523 1.84889 7.88235 1.92118 8.1663 1.70218L8.19806 1.67879C8.83544 1.19188 9.70712 1.26842 10.2591 1.86165C10.8846 2.53142 10.8846 3.61581 10.2591 4.28558L8.03127 6.67549C7.40581 7.34526 6.39315 7.34526 5.76768 6.67549C5.2137 6.08226 5.14222 5.14884 5.59692 4.46844L5.61876 4.43442C5.82328 4.12823 5.75577 3.70298 5.47183 3.48611C5.18789 3.26923 4.78878 3.33939 4.58625 3.64345L4.56441 3.67747C3.74634 4.89794 3.8754 6.57343 4.86821 7.63656C5.99007 8.83789 7.8069 8.83789 8.92877 7.63656L11.1586 5.24877ZM0.8414 4.75123C-0.280467 5.95256 -0.280467 7.89809 0.8414 9.09942C1.8342 10.1625 3.39886 10.3008 4.54058 9.42686L4.57235 9.40347C4.85828 9.18447 4.9238 8.75922 4.71929 8.45516C4.51477 8.15111 4.11765 8.07882 3.83371 8.29782L3.80194 8.32121C3.16456 8.80812 2.29288 8.73158 1.74088 8.13835C1.11541 7.46646 1.11541 6.38207 1.74088 5.7123L3.96873 3.32451C4.59419 2.65474 5.60685 2.65474 6.23232 3.32451C6.7863 3.91774 6.85778 4.85116 6.40308 5.53369L6.38124 5.56771C6.17672 5.87389 6.24423 6.29914 6.52817 6.51602C6.81211 6.7329 7.21122 6.66273 7.41375 6.35868L7.43559 6.32466C8.25366 5.10206 8.1246 3.42657 7.13179 2.36344C6.00993 1.16211 4.1931 1.16211 3.07123 2.36344L0.8414 4.75123Z" fill="white"/></svg> 
            Copy link
        </button>
        </div>
        <div id="share-link-placeholder" style="padding: 0 20px;"></div>
        <br>

        <table id="legalcheckboxes">
        </table>
    </div>
    <br> <br>
</div> <!-- Calculator -->
<script>
let $ = document;
// var url = `${BUCKET_ROOT}/pricelist-index.json`;
const DELETE_SVG = '<svg width="10" height="11" viewBox="0 0 10 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.70404 1.85522C10.0945 1.46478 10.0945 0.830704 9.70404 0.440262C9.3136 0.0498199 8.67952 0.0498199 8.28908 0.440262L5 3.73247L1.70779 0.443385C1.31735 0.0529434 0.683273 0.0529434 0.292831 0.443385C-0.0976105 0.833827 -0.0976105 1.4679 0.292831 1.85835L3.58504 5.14743L0.295955 8.43964C-0.0944869 8.83008 -0.0944869 9.46416 0.295955 9.8546C0.686397 10.245 1.32047 10.245 1.71092 9.8546L5 6.56239L8.29221 9.85147C8.68265 10.2419 9.31673 10.2419 9.70717 9.85147C10.0976 9.46103 10.0976 8.82695 9.70717 8.43651L6.41496 5.14743L9.70404 1.85522Z" fill="#C1C1C1"/></svg>';
const UP_SVG = '<svg width="20" height="10" viewBox="0 0 20 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.26209 8.71104C1.11739 8.55 1.13078 8.30211 1.29198 8.15759L8.29955 1.87527C9.47634 0.820267 11.2698 0.859187 12.3997 1.96425L18.7321 8.15737C18.8819 8.30382 18.8896 8.54227 18.7496 8.69806V8.69806C18.6014 8.86294 18.346 8.87175 18.1868 8.71747L12.3852 3.094C11.26 2.00329 9.48481 1.96243 8.31056 3.0002L1.81283 8.74274C1.65168 8.88516 1.40584 8.87101 1.26209 8.71104V8.71104Z" fill="#C1C1C1" stroke="#C1C1C1"/></svg>';
const DOWN_SVG = '<svg width="20" height="10" viewBox="0 0 20 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.7379 1.28896C18.8826 1.45 18.8692 1.69789 18.708 1.84241L11.7005 8.12473C10.5237 9.17973 8.73019 9.14081 7.60027 8.03575L1.26787 1.84263C1.11813 1.69618 1.11044 1.45773 1.25043 1.30194V1.30194C1.39858 1.13706 1.65405 1.12825 1.81321 1.28253L7.61478 6.906C8.74003 7.99671 10.5152 8.03757 11.6894 6.9998L18.1872 1.25726C18.3483 1.11484 18.5942 1.12899 18.7379 1.28896V1.28896Z" fill="#C1C1C1" stroke="#C1C1C1"/></svg>';
const pricekey = 'price_' + conformity;
const SUPPORT_MARKUPS_MAP = {
    'e': (price) => price + Math.max(5000, price*0.3),   // TODO get support start prices for every countries
    'b': (price) => price + Math.max(250, price*0.1),
    'p': (price) => price + 50,
    's': (price) => price,
}
fetch('pricelist-index.json').then(res => res.json()).then(res => {
const DCS = res.dcs;
const CURRENCY = res[sub].locale.currencyCode;
const TAX_RATE = res[sub].locale.taxRate;
const lastupdated = res.date;

let loadedState = {};
res = res[sub];

{% include 'js/serialize.js' %}
{% include 'js/calculator-utils.js' %}

// TODOS
// get legal condition in fr and en
// get support prices for every countries
// export excel

try {
    loadedState = DeserializeURI();
} catch(err) {
    console.error(err);
}
let state = {
    'title': loadedState.title || '', 'company': loadedState.company || '', 'author': loadedState.author || '',
    'check-b': true,
    'check-q': true,
    'check-p': true,
    'zones': [], // loadedState.zones.length ? loadedState.zones : {key: 'SBG', items: []}, // {key, items: [{key, description, setupfee, pricePerUnit, quantity:  commit:  discount: 0, total}]}
    'support': loadedState.support || 'b',
    'totaldiscount': loadedState.totaldiscount || 0,
    'total': 0, 'totalSupport': 0, 'totalSupportLocalTax': 0, 'installfee': 0,
};

for (const i in loadedState.zones) {
    const z = addZone(loadedState.zones[i].key);
    for (const j in loadedState.zones[i].items) {
        AddItemToZone(z, loadedState.zones[i].items[j]);
    }
}
if (!(state.zones.length)) {
    addZone('SBG');
}

setLastUpdated(lastupdated);
setConformityList();

Object.keys(ABREV_TOTAL).forEach((id) => {
    $.getElementById(id).value = state[id];
    $.getElementById(id).addEventListener('change', () => {
        state[id] = $.getElementById(id).value;
        renderTotalPrice();
    });
});
$.getElementById('add-zone').addEventListener('click', () => addZone());
$.getElementById('copy-link-button').addEventListener('click', () => {
    const uri = SerilizeState(state);
    $.getElementById('share-link-placeholder').innerHTML = uri;
    alert("Copied the text in clipboard: \n" + uri);
});


function renderTotalPrice() {
    let total = 0; let installFee = 0;
    for (const z of state.zones) {
        for (const i of z.items) {
            if (!(Object.keys(i).length)) {
                continue;
            }
            total += i.total;
            installFee += i.setupfee;
        }
    }
    state.total = total * ((100 - state.totaldiscount)/100);
    state.installfee = installFee;
    state.totalSupport = SUPPORT_MARKUPS_MAP[state.support](state.total);
    state.totalSupportLocalTax = (state.totalSupport * ((100+TAX_RATE)/100));
    $.getElementById('price-placeholder').innerHTML = `
    <table style="margin-top: 34px; font-size: 1rem;"><tbody>
        <tr><td>Mensuel HT</td> <td>${state.total.toFixed(2)} ${CURRENCY}</td> </tr>
        <tr><td><b>Mensuel HT + Support</b></td> <td><b>${state.totalSupport.toFixed(2)} ${CURRENCY}</b></td> </tr>
        <tr><td>Mensuel TCC (${TAX_RATE}%)</td> <td>${state.totalSupportLocalTax.toFixed(2)} ${CURRENCY}</td> </tr>
        <tr><td>Frais d'installation</td> <td>${state.installfee.toFixed(2)} ${CURRENCY}</td> </tr>
    </tbody></table>
    `;
}

function addZone(key) {
    const zoneIndex = state.zones.length;
    let newzone = document.createElement('div');
    newzone.setAttribute('class', `zone zone${zoneIndex}`);
    newzone.setAttribute('data-zone', `${zoneIndex}`);
    const selected = key || 'SBG';
    const options = Object.keys(DCS).map(key => `<option value="${key}" ${key == selected ? 'selected' : ''}>${key} - ${DCS[key].city} (${DCS[key].country})</option>`).join('');
    let deleteBtn = `<button class="btn" type="button" id="z${zoneIndex}-delete">${DELETE_SVG}</button>`;
    if (zoneIndex == 0) {
        deleteBtn = '';
    }
    newzone.innerHTML = `
    <h3>
        ${deleteBtn}
        Zone
        <select id="z${zoneIndex}" class="form-select form-select-sm" aria-label="Default select example" style="width: 200px; margin-left: 20px;">
            ${options}
        </select>
        <span class="sep"></span>
    </h3>
    <table style="margin-bottom: 5px;width:100%;min-width: 1000px;">
        <thead style="display: none;">
          <th style="padding-left: 47px">Item</th>
          <th class="item-th">Setup Cost (${CURRENCY})</th>
          <th class="item-th">Cost per Unit (${CURRENCY})</th>
          <th class="item-th"># Quantity</th>
          <th class="item-th">Commitment (Month)</th>
          <th class="item-th">Discount on Commitment (%)</th>
          <th class="item-th">Cost / Month (${CURRENCY})</th>
        </thead>
        <tbody class="draggable-container"></tbody>
    </table>
    <div class="search-placeholder"></div>
    <button id="add-item-zone${zoneIndex}" class="btn btn-sm btn-primary add-item" style="margin-left: 47px">+ Add Item</button>
    `;
    $.getElementById('zones').appendChild(newzone);
    state.zones.push({'key': selected, 'items': []})
    $.getElementById(`z${zoneIndex}`).addEventListener('change', (e) => state.zones[zoneIndex].key = e.target.value);
    $.getElementById(`add-item-zone${zoneIndex}`).addEventListener('click', function() {AddItemOnClick(this)});
    
    if (zoneIndex > 0) {
        $.getElementById(`z${zoneIndex}-delete`).addEventListener('click', function() {
            this.parentElement.parentElement.remove();
            state.zones[zoneIndex] = {items: []};
        });
    }
    return $.querySelector(`.zone${zoneIndex}`);
}

function SearchFilterRender(state) { return  `<div>
    Search in catalogs: &nbsp;&nbsp;
    <input class="catalog-filter form-check-input" type="checkbox" value="" id="check-b" ${(state['check-b']) ? 'checked' : ''}>
    <label class="form-check-label" for="check-b"> Baremetal</label>
    &nbsp;
    <input class="catalog-filter form-check-input" type="checkbox" value="" id="check-q" ${(state['check-q']) ? 'checked' : ''}>
    <label class="form-check-label" for="check-p"> Private Cloud</label>
    &nbsp;
    <input class="catalog-filter form-check-input" type="checkbox" value="" id="check-p" ${(state['check-p']) ? 'checked' : ''}>
    <label class="form-check-label" for="check-p"> Public Cloud</label>
</div>`}

function SearchFilterEffects(zone, inputTxt, list_group) {
    $.querySelectorAll('.catalog-filter').forEach(function(el) {
        el.addEventListener('change', function(e) {
            state[el.id] = el.checked;
            SearchOnKeyUp(zone, inputTxt, list_group);
        })
    });
}

function SearchOnKeyUp(zone, inputTxt, list_group) {
    let index_keys = [];
    const prefixes =  ['check-b', 'check-q', 'check-p'].map(x => state[x] ? x.split('-')[1] : false).filter(x => x);
    inputTxt.parentElement.classList.add("active");
    list_group.style.display = "block";
    list_group.innerHTML = SearchFilterRender(state);

    const tokens = inputTxt.value.toLowerCase().split(' ').filter(x => x.length > 1);
    index_keys = index_keys.concat(Object.keys(res).filter(function (key) {
        if (!(prefixes.includes(key.charAt(0)))) {
            return false;
        }
        if (!inputTxt.value) {
            return true;
        }
        const desc = res[key].description.toLowerCase();
        for (const token of tokens) {
            if (!(desc.includes(token))) {
                return false;
            }
        }
        return true;
    }));

    if (!index_keys.length) {
        list_group.innerHTML += "<li>Result not Found, Try typing something else</li>";;
    } else {
        list_group.innerHTML += index_keys.map(function (key) {
            let text = res[key].description;
            for (const token of tokens) {
                text = text.replaceAll(RegExp(token, 'gi'), '<b>$&</b>')
            }
            return `<li data-key="${key}">${text}<span class='float-right'>${pricekey in res[key] ? res[key][pricekey] : res[key].price} ${res.locale.currencyCode}</span></li>`;
        }).join('');
        
        all_list_items = list_group.querySelectorAll("li");
        all_list_items.forEach(function (list) {
            list.addEventListener("click", function (e) {
                AddItemToZone(zone, getItem(list.getAttribute('data-key')))
                list_group.style.display = "none";
                SearchDestroy(zone)
            });
        });
    }
    SearchFilterEffects(zone, inputTxt, list_group);
}

function SearchDestroy(zone) {
    zone.querySelector('.search-placeholder').innerHTML = '';
    // $.querySelectorAll('.catalog-filter').forEach(function(el) {
    //     el.removeEventListener('change');
    // });
    // $.querySelectorAll('.catalog-filter').forEach(function (list) {
    //         list.addEventListener("click", function (e) {
}

function AddItemOnClick(el) {
    const zone = el.parentElement;
    zone.querySelector('.search-placeholder').innerHTML = `
<div class="search" style="position: relative">
        <input id="inputTxt" class="form-control"  placeholder="Type to search..." style="border-radius: 7px 7px 0 0">
        <span style="position: absolute;right: 13px; top: 8px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="16px"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg></span>
    </div>
    <div class="list-group" tabindex="0"></div>
`;
    // setTimeout(()=>{}, 0);
    const inputTxt = $.getElementById('inputTxt');
    const listGroup = zone.querySelector(".list-group");
    inputTxt.addEventListener("keyup", () => SearchOnKeyUp(zone, inputTxt, listGroup));
    inputTxt.addEventListener('focusout', (e) => { 
        e.preventDefault(); e.stopPropagation();
        const targetElementClass = e.relatedTarget ? e.relatedTarget.getAttribute('class') : null;
        if (e.relatedTarget && (targetElementClass.includes('list-group') || targetElementClass.includes('catalog-filter'))) {
        } else {
            SearchDestroy(zone);
        }
    });
    inputTxt.focus();
    SearchOnKeyUp(zone, inputTxt, listGroup);
}

function AddItemToZone(zone, item) {
    const zoneIndex = parseInt(zone.getAttribute('data-zone'));
    const itemIndex = state.zones[zoneIndex].items.length; 
    let tr = $.createElement('tr');
    tr.innerHTML = `
    <td>
        <div class="item-first-row">
            <button class="btn btn" type="button" id="z${zoneIndex}-item${itemIndex}-delete">${DELETE_SVG}</button>
            <span class="item-first-row-text lighter">${item.description}</span>
        </div>
    </td>
    <td class="lighter" id="z${zoneIndex}-item${itemIndex}-setupfee">${item.setupfee}</td>
    <td class="lighter">${item.pricePerUnit}</td>
    <td><input type="number" id="z${zoneIndex}-item${itemIndex}-quantity" class="form-control form-control-sm" placeholder="0" min="0" value="${item.quantity}" style="max-width: 70px"></td>
    <td><input type="number" id="z${zoneIndex}-item${itemIndex}-commit" class="form-control form-control-sm" placeholder="1" min="1" max="60" value="${item.commit}" style="max-width: 52px; background: transparent;"></td>
    <td><input type="number" id="z${zoneIndex}-item${itemIndex}-discount" class="form-control form-control-sm" placeholder="0" min="0" max="100" value="${item.discount}" style="max-width: 52px; background: transparent;"></td>
    <td><b id="z${zoneIndex}-item${itemIndex}-total">${item.total}</b></td>`;
    state.zones[zoneIndex].items.push(item);
    zone.querySelector('table tbody').appendChild(tr);
    zone.querySelector('table thead').style.display = 'table-header-group';

    function updateTotalPrice(zoneIndex, itemIndex) {
        let stateItem = state.zones[zoneIndex].items[itemIndex];
        stateItem['total'] = stateItem['pricePerUnit'] * stateItem.quantity * (1 - (stateItem.discount) / 100);
        $.getElementById(`z${zoneIndex}-item${itemIndex}-total`).innerText = stateItem['total'];
        $.getElementById(`z${zoneIndex}-item${itemIndex}-setupfee`).innerText = (stateItem['setupfee'] * stateItem.quantity);
        renderTotalPrice();
    }

    $.getElementById(`z${zoneIndex}-item${itemIndex}-delete`).addEventListener('click', (el) => {
        // console.log(el.currentTarget.parentElement.parentElement.parentElement);
        el.currentTarget.parentElement.parentElement.parentElement.remove();
        state.zones[zoneIndex].items[itemIndex] = {};
        renderTotalPrice();
    });
    $.getElementById(`z${zoneIndex}-item${itemIndex}-quantity`).addEventListener('change', (e) => {
        state.zones[zoneIndex].items[itemIndex].quantity = e.target.value;
        updateTotalPrice(zoneIndex, itemIndex)
    });
    $.getElementById(`z${zoneIndex}-item${itemIndex}-commit`).addEventListener('change', (e) => {
        state.zones[zoneIndex].items[itemIndex].commit = e.target.value;
        updateTotalPrice(zoneIndex, itemIndex);
    });
    $.getElementById(`z${zoneIndex}-item${itemIndex}-discount`).addEventListener('change', (e) => {
        state.zones[zoneIndex].items[itemIndex].discount = e.target.value;
        updateTotalPrice(zoneIndex, itemIndex);
    });
    renderTotalPrice();
}

}) // fetch
</script>

{% endblock %}